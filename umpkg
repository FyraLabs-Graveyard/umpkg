#!/usr/bin/python3

import koji
import typer
import os
import sys
import umpkg_cli.cfg as config
import umpkg_cli.util as util
from umpkg_cli.util import session

cfg = config.read_config()

app = typer.Typer()
@app.command()
def build(
    tag: str = typer.Argument(None, help="The Koji tag to build"),
    path: str = typer.Argument(None, help="The path to the package"),
):
    """[summary]
    Builds a package in the current git repository
    """
    if not tag:
        # then check if the tag is set in the config
        if not cfg['tag']:
            print("No tag specified and no default tag set in config! Exiting...")
            sys.exit(1)
        else:
            tag = cfg['tag']
    
    if not path:
        path = os.getcwd()
    if not os.path.exists(path):
        typer.echo("Path does not exist! Exiting...")
        sys.exit(1)
    if not os.path.isdir(path):
        typer.echo("Path is not a directory! Exiting...")
        sys.exit(1)
    # check if path is a git link
    if path.endswith(".git"):
        # clone the repo to a temporary directory
        pkgpath = util.clone_repo(path)
        util.build_src(tag, pkgpath)
    # elif path is already an srpm
    elif path.endswith(".src.rpm"):
        pkgpath = path
        util.build_srpm(tag,pkgpath)
    else:
        util.build_src(tag, path)

@app.command()
def help():
    """
    Displays help information
    """
    typer.echo("You called for help, but no one came...")

if __name__ == "__main__":
    app()